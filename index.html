<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8" />
<title>שחמט מתקדם – לימוד</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    background: #e2e8f0;
    direction: rtl;
    padding-bottom: 50px;
  }
  h1 { margin-top: 20px; }
  #board {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    width: 480px;
    height: 480px;
    margin: 20px auto;
    border: 6px solid #333;
    box-shadow: 0 0 20px rgba(0,0,0,0.2);
  }
  .cell {
    width: 60px;
    height: 60px;
    font-size: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s;
  }
  .dark { background: #4ade80; }
  .light { background: #bbf7d0; }
  .selected {
    outline: 4px solid gold;
    box-shadow: inset 0 0 10px rgba(255,215,0,0.5);
  }
  .valid-move {
    background: #facc15 !important;
    opacity: 0.7;
  }
  #message {
    margin-top: 10px;
    font-weight: bold;
    font-size: 18px;
  }
</style>
</head>
<body>

<h1>♟️ שחמט מתקדם – גרסה חינמית</h1>
<p>בחר כלי כדי לראות את המהלכים החוקיים</p>

<div id="board"></div>
<div id="message">בחר כלי כדי להתחיל</div>

<script>
const boardElement = document.getElementById("board");
const message = document.getElementById("message");

let selected = null;
let turn = "white"; // white / black
let enPassant = null; // רישום מהלך en passant
let movedKings = {white:false, black:false};
let movedRooks = {white:{h1:false,a1:false}, black:{h8:false,a8:false}};

let board = [
  ["♜","♞","♝","♛","♚","♝","♞","♜"],
  ["♟","♟","♟","♟","♟","♟","♟","♟"],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["♙","♙","♙","♙","♙","♙","♙","♙"],
  ["♖","♘","♗","♕","♔","♗","♘","♖"]
];

// פונקציה בסיסית לזיהוי צבע הכלי
function getColor(piece){
  if(piece.match(/[♙♖♘♗♕♔]/)) return "white";
  if(piece.match(/[♟♜♞♝♛♚]/)) return "black";
  return null;
}

// פונקציה להחזרת מהלכים חוקיים (חיילים, צריחים, פרש, רץ, מלכה, מלך, הצרחה, אנ-פאסנט)
function getValidMoves(r,c){
  const piece = board[r][c];
  const color = getColor(piece);
  const moves = [];

  if(color !== turn) return moves; // לא תורך

  const directions = {
    "♖": [[1,0],[-1,0],[0,1],[0,-1]],
    "♜": [[1,0],[-1,0],[0,1],[0,-1]],
    "♗": [[1,1],[1,-1],[-1,1],[-1,-1]],
    "♝": [[1,1],[1,-1],[-1,1],[-1,-1]],
    "♕": [[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]],
    "♛": [[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]]
  };

  // פרש
  const knightMoves = [[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]];

  if(piece === "♙"){ // חייל לבן
    if(r>0 && board[r-1][c]==="") moves.push({r:r-1,c:c});
    if(r===6 && board[4][c]==="") moves.push({r:4,c:c}); // קפיצה 2 שלבים
    if(r>0 && c>0 && getColor(board[r-1][c-1])==="black") moves.push({r:r-1,c:c-1});
    if(r>0 && c<7 && getColor(board[r-1][c+1])==="black") moves.push({r:r-1,c:c+1});
    // אנ-פאסנט
    if(enPassant && enPassant.r===r-1 && Math.abs(enPassant.c-c)===1) moves.push({r:enPassant.r,c:enPassant.c, enPassant:true});
  }

  if(piece === "♟"){ // חייל שחור
    if(r<7 && board[r+1][c]==="") moves.push({r:r+1,c:c});
    if(r===1 && board[3][c]==="") moves.push({r:3,c:c}); // קפיצה 2 שלבים
    if(r<7 && c>0 && getColor(board[r+1][c-1])==="white") moves.push({r:r+1,c:c-1});
    if(r<7 && c<7 && getColor(board[r+1][c+1])==="white") moves.push({r:r+1,c:c+1});
    // אנ-פאסנט
    if(enPassant && enPassant.r===r+1 && Math.abs(enPassant.c-c)===1) moves.push({r:enPassant.r,c:enPassant.c, enPassant:true});
  }

  // כלים קווים ישרים / אלכסוניים
  if(["♖","♜","♗","♝","♕","♛"].includes(piece)){
    const dirs = directions[piece];
    dirs.forEach(d=>{
      let nr = r + d[0], nc = c + d[1];
      while(nr>=0 && nr<=7 && nc>=0 && nc<=7){
        const target = board[nr][nc];
        if(target==="") moves.push({r:nr,c:nc});
        else {
          if(getColor(target)!==color) moves.push({r:nr,c:nc});
          break;
        }
        if(["♖","♜","♗","♝","♕","♛"].includes(piece)) {nr+=d[0]; nc+=d[1];}
        else break;
      }
    });
  }

  // פרש
  if(["♘","♞"].includes(piece)){
    knightMoves.forEach(d=>{
      const nr=r+d[0], nc=c+d[1];
      if(nr>=0 && nr<=7 && nc>=0 && nc<=7 && getColor(board[nr][nc])!==color){
        moves.push({r:nr,c:nc});
      }
    });
  }

  // מלך
  if(["♔","♚"].includes(piece)){
    const kingDirs = [[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]];
    kingDirs.forEach(d=>{
      const nr=r+d[0], nc=c+d[1];
      if(nr>=0 && nr<=7 && nc>=0 && nc<=7 && getColor(board[nr][nc])!==color){
        moves.push({r:nr,c:nc});
      }
    });

    // הצרחה
    if(piece==="♔" && !movedKings.white){
      if(!movedRooks.white.h1 && board[7][5]==="" && board[7][6]==="") moves.push({r:7,c:6,castle:"kingside"});
      if(!movedRooks.white.a1 && board[7][1]==="" && board[7][2]==="" && board[7][3]==="") moves.push({r:7,c:2,castle:"queenside"});
    }
    if(piece==="♚" && !movedKings.black){
      if(!movedRooks.black.h8 && board[0][5]==="" && board[0][6]==="") moves.push({r:0,c:6,castle:"kingside"});
      if(!movedRooks.black.a8 && board[0][1]==="" && board[0][2]==="" && board[0][3]==="") moves.push({r:0,c:2,castle:"queenside"});
    }
  }

  return moves;
}

// פונקציה לבדיקה אם המלך יהיה בשח
function isKingSafe(color){ 
  // ניתן להרחיב לבדיקה מלאה - כרגע מחזירה תמיד true
  return true; 
}

// פונקציה לציור הלוח והסימון
function drawBoard(){
  boardElement.innerHTML="";
  board.forEach((row,r)=>{
    row.forEach((cell,c)=>{
      const div=document.createElement("div");
      div.className="cell "+((r+c)%2?"dark":"light");
      div.textContent=cell;
      if(selected && selected.r===r && selected.c===c) div.classList.add("selected");

      if(selected){
        const valid=getValidMoves(selected.r,selected.c);
        valid.forEach(m=>{if(m.r===r && m.c===c) div.classList.add("valid-move");});
      }

      div.onclick=()=>clickCell(r,c);
      boardElement.appendChild(div);
    });
  });
}

// פונקציה ללחיצה על משבצת
function clickCell(r,c){
  if(selected){
    const valid=getValidMoves(selected.r,selected.c);
    const moveHere=valid.find(m=>m.r===r && m.c===c);
    if(moveHere){
      // הצרחה
      if(moveHere.castle){
        if(moveHere.castle==="kingside"){
          board[r][c]=board[selected.r][selected.c];
          board[selected.r][selected.c]="";
          if(turn==="white"){
            board[7][5]="♖"; board[7][7]=""; movedRooks.white.h1=true;
          } else{
            board[0][5]="♜"; board[0][7]=""; movedRooks.black.h8=true;
          }
        }
        if(moveHere.castle==="queenside"){
          board[r][c]=board[selected.r][selected.c];
          board[selected.r][selected.c]="";
          if(turn==="white"){
            board[7][3]="♖"; board[7][0]=""; movedRooks.white.a1=true;
          } else{
            board[0][3]="♜"; board[0][0]=""; movedRooks.black.a8=true;
          }
        }
        movedKings[turn]=true;
      } else {
        // אנ-פאסנט
        if(moveHere.enPassant){
          board[selected.r][moveHere.c]="";
        }
        // עדכון המיקום
        board[r][c]=board[selected.r][selected.c];
        board[selected.r][selected.c]="";
      }

      // בדיקת פרומושן
      if(board[r][c]==="♙" && r===0) promotePawn(r,c,"white");
      if(board[r][c]==="♟" && r===7) promotePawn(r,c,"black");

      // עדכון תורות
      turn = (turn==="white")?"black":"white";
      selected=null;
      message.textContent="מהלך בוצע! תור "+turn;
    } else if(board[r][c]!=="") {
      selected={r,c};
      message.textContent="בחר משבצת יעד";
    } else {
      selected=null;
      message.textContent="בחר כלי כדי להתחיל";
    }
  } else if(board[r][c]!=="") {
    selected={r,c};
    message.textContent="בחר משבצת יעד";
  }
  drawBoard();
}

// פרומושן
function promotePawn(r,c,color){
  const choice=prompt("בחר כלי לפרומושן: ♕ ♖ ♗ ♘","");
  if(choice && ["♕","♖","♗","♘"].includes(choice)){
    board[r][c]= (color==="white") ? choice : choice.replace("♕","♛").replace("♖","♜").replace("♗","♝").replace("♘","♞");
  } else {
    board[r][c]= (color==="white") ? "♕" : "♛";
  }
}

// התחלת ציור הלוח
drawBoard();
