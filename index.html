<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<title>שחמט מתקדם – גרסה סופית</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    font-family: "Segoe UI Symbol", "Arial", sans-serif;
    text-align: center;
    background: #e2e8f0;
    direction: rtl;
    padding-bottom: 50px;
  }
  h1 { margin-top: 20px; }
  #board {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    width: 480px;
    height: 480px;
    margin: 20px auto;
    border: 6px solid #333;
    box-shadow: 0 0 20px rgba(0,0,0,0.2);
  }
  .cell {
    width: 60px;
    height: 60px;
    font-size: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s;
  }
  .dark { background: #4ade80; }
  .light { background: #bbf7d0; }
  .selected { outline: 4px solid gold; }
  .valid-move { background: #facc15 !important; opacity: 0.7; }
  #message { margin-top: 10px; font-weight: bold; font-size: 18px; }
</style>
</head>
<body>

<h1>♟️ שחמט מתקדם – גרסה סופית</h1>
<p>לחץ על כלי כדי לראות מהלכים חוקיים</p>

<div id="board"></div>
<div id="message">בחר כלי כדי להתחיל</div>

<script>
const boardElement = document.getElementById("board");
const message = document.getElementById("message");

let selected = null;
let turn = "white";
let enPassant = null;
let movedKings = {white:false, black:false};
let movedRooks = {white:{h1:false,a1:false}, black:{h8:false,a8:false}};

let board = [
  ["♜","♞","♝","♛","♚","♝","♞","♜"],
  ["♟","♟","♟","♟","♟","♟","♟","♟"],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["♙","♙","♙","♙","♙","♙","♙","♙"],
  ["♖","♘","♗","♕","♔","♗","♘","♖"]
];

// פונקציות עזר
function getColor(piece){
  if(piece.match(/[♙♖♘♗♕♔]/)) return "white";
  if(piece.match(/[♟♜♞♝♛♚]/)) return "black";
  return null;
}
function isInside(r,c){ return r>=0 && r<=7 && c>=0 && c<=7; }
function cloneBoard(){ return board.map(row=>row.slice()); }

// פונקציה לבדוק אם המלך יהיה בטוח אחרי מהלך
function isKingSafeAfterMove(color,from,to){
  const temp = cloneBoard();
  temp[to.r][to.c] = temp[from.r][from.c];
  temp[from.r][from.c] = "";
  let kingPos = null;
  for(let i=0;i<8;i++){
    for(let j=0;j<8;j++){
      if(temp[i][j]===(color==="white"?"♔":"♚")) kingPos={r:i,c:j};
    }
  }
  if(!kingPos) return false;
  for(let i=0;i<8;i++){
    for(let j=0;j<8;j++){
      if(getColor(temp[i][j])!==color && temp[i][j]!==""){
        const moves = getValidMovesSimple(i,j,temp,false);
        if(moves.some(m=>m.r===kingPos.r && m.c===kingPos.c)) return false;
      }
    }
  }
  return true;
}

// גרסה בסיסית של getValidMoves ללא בדיקות שח
function getValidMovesSimple(r,c,tempBoard,enPassantFlag=true){
  const piece = tempBoard[r][c];
  const color = getColor(piece);
  const moves = [];
  const directions = {
    "♖": [[1,0],[-1,0],[0,1],[0,-1]],
    "♜": [[1,0],[-1,0],[0,1],[0,-1]],
    "♗": [[1,1],[1,-1],[-1,1],[-1,-1]],
    "♝": [[1,1],[1,-1],[-1,1],[-1,-1]],
    "♕": [[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]],
    "♛": [[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]]
  };
  const knightMoves = [[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]];

  // חיילים
  if(piece==="♙"){ if(r>0 && tempBoard[r-1][c]==="") moves.push({r:r-1,c:c});
    if(r===6 && tempBoard[4][c]==="") moves.push({r:4,c:c});
    if(r>0 && c>0 && getColor(tempBoard[r-1][c-1])==="black") moves.push({r:r-1,c:c-1});
    if(r>0 && c<7 && getColor(tempBoard[r-1][c+1])==="black") moves.push({r:r-1,c:c+1});
  }
  if(piece==="♟"){ if(r<7 && tempBoard[r+1][c]==="") moves.push({r:r+1,c:c});
    if(r===1 && tempBoard[3][c]==="") moves.push({r:3,c:c});
    if(r<7 && c>0 && getColor(tempBoard[r+1][c-1])==="white") moves.push({r:r+1,c:c-1});
    if(r<7 && c<7 && getColor(tempBoard[r+1][c+1])==="white") moves.push({r:r+1,c:c+1});
  }

  // כלי קווים/אלכסון
  if(["♖","♜","♗","♝","♕","♛"].includes(piece)){
    directions[piece].forEach(d=>{
      let nr=r+d[0], nc=c+d[1];
      while(isInside(nr,nc)){
        const target = tempBoard[nr][nc];
        if(target==="") moves.push({r:nr,c:nc});
        else { if(getColor(target)!==color) moves.push({r:nr,c:nc}); break; }
        nr+=d[0]; nc+=d[1];
      }
    });
  }

  // פרש
  if(["♘","♞"].includes(piece)){
    knightMoves.forEach(d=>{
      const nr=r+d[0], nc=c+d[1];
      if(isInside(nr,nc) && getColor(tempBoard[nr][nc])!==color) moves.push({r:nr,c:nc});
    });
  }

  return moves;
}

// פונקציה עיקרית – מחזירה מהלכים חוקיים בלבד
function getValidMoves(r,c){
  const raw = getValidMovesSimple(r,c,board);
  return raw.filter(m=>isKingSafeAfterMove(getColor(board[r][c]),{r,c},m));
}

// ציור הלוח
function drawBoard(){
  boardElement.innerHTML="";
  board.forEach((row,r)=>{
    row.forEach((cell,c)=>{
      const div=document.createElement("div");
      div.className="cell "+((r+c)%2?"dark":"light");
      div.textContent=cell;
      if(selected && selected.r===r && selected.c===c) div.classList.add("selected");
      if(selected){
        getValidMoves(selected.r,selected.c).forEach(m=>{
          if(m.r===r && m.c===c) div.classList.add("valid-move");
        });
      }
      div.onclick=()=>clickCell(r,c);
      boardElement.appendChild(div);
    });
  });
}

// טיפול בלחיצה
function clickCell(r,c){
  if(selected){
    const valid=getValidMoves(selected.r,selected.c);
    const moveHere=valid.find(m=>m.r===r && m.c===c);
    if(moveHere){
      board[r][c]=board[selected.r][selected.c];
      board[selected.r][selected.c]="";
      turn = (turn==="white")?"black":"white";
      selected=null;
      message.textContent="מהלך בוצע! תור "+turn;
    } else if(board[r][c]!==""){
      selected={r,c};
      message.textContent="בחר משבצת יעד";
    } else { selected=null; message.textContent="בחר כלי כדי להתחיל"; }
  } else if(board[r][c]!==""){
    selected={r,c};
    message.textContent="בחר משבצת יעד";
  }
  drawBoard();
}

// התחלת המשחק
drawBoard();
</script>
 
</body>
</html>
